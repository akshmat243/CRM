{% extends 'admin_dashboard/staff/base.html' %}
{% block content %}
{% load static %}

<div class="dashboard-main-body admin_dashboard">

  <div class="dash-title">Assigned Lead</div>



  <div class="row gy-4">
    <div class="col-xxl-3 col-md-4 col-6">
      <a href="{% url 'all_leads_data' 'total_visit_tag' %}" style="display: block;">
        <div class="desh-card">
          <div class="desh-card-body">
            <div class="admin-icon">
              <iconify-icon icon="iconamoon:discount-fill" class="icon total_visit"></iconify-icon>
            </div>
            <div class="admin-title">
              Total Visits : {{ total_visit_leads }}</div>
            <!-- <p class="fw-semibold">{{ logged_in_count }}</p> -->
            <!-- <div id="active-user-chart" class="remove-tooltip-title rounded-tooltip-value"></div> -->
          </div>
        </div>
      </a>
    </div>
    <div class="col-xxl-3 col-md-4 col-6">
      <a href="{% url 'all_leads_data' 'total_interested_tag' %}" style="display: block;">
        <div class="desh-card">
          <div class="desh-card-body">
            <div class="admin-icon">
              <iconify-icon icon="iconamoon:discount-fill" class="icon team_interented"></iconify-icon>
            </div>
            <div class="admin-title">
              Interested : {{ total_interested_leads }}</div>
            <!-- <p class="fw-semibold">{{ logged_in_count }}</p> -->
            <!-- <div id="active-user-chart" class="remove-tooltip-title rounded-tooltip-value"></div> -->
          </div>
        </div>
      </a>
    </div>

    <div class="col-xxl-3 col-md-4 col-6">
      <a href="{% url 'all_leads_data' 'total_not_interested_tag' %}" style="display: block;">
        <div class="desh-card">
          <div class="desh-card-body">
            <div class="admin-icon">
              <iconify-icon icon="iconamoon:discount-fill" class="icon team_ntint"></iconify-icon>
            </div>
            <div class="admin-title">
              Not Interested : {{total_not_interested_leads }}</div>
            <!-- <p class="fw-semibold">{{ logged_in_count }}</p> -->
            <!-- <div id="active-user-chart" class="remove-tooltip-title rounded-tooltip-value"></div> -->
          </div>
        </div>
      </a>
    </div>

    <div class="col-xxl-3 col-md-4 col-6">
      <a href="{% url 'all_leads_data' 'total_other_location_tag' %}" style="display: block;">
        <div class="desh-card">
          <div class="desh-card-body">
            <div class="admin-icon">
              <iconify-icon icon="iconamoon:discount-fill" class="icon team_ltion"></iconify-icon>
            </div>
            <div class="admin-title">
              Other Location : {{ total_other_location_leads}}</div>
            <!-- <p class="fw-semibold">{{ logged_in_count }}</p> -->
            <!-- <div id="active-user-chart" class="remove-tooltip-title rounded-tooltip-value"></div> -->
          </div>
        </div>
      </a>
    </div>

    <div class="col-xxl-3 col-md-4 col-6">
      <a href="{% url 'all_leads_data' 'total_not_picked_tag' %}" style="display: block;">
        <div class="desh-card">
          <div class="desh-card-body">
            <div class="admin-icon">
              <iconify-icon icon="iconamoon:discount-fill" class="icon team_ntpck"></iconify-icon>
            </div>
            <div class="admin-title">
              Not Picked : {{ total_not_picked_leads}}</div>
            <!-- <p class="fw-semibold">{{ logged_in_count }}</p> -->
            <!-- <div id="active-user-chart" class="remove-tooltip-title rounded-tooltip-value"></div> -->
          </div>
        </div>
      </a>
    </div>

    <div class="col-xxl-3 col-md-4 col-6">
      <a href="{% url 'all_leads_data' 'total_lost_tag' %}" style="display: block;">
        <div class="desh-card">
          <div class="desh-card-body">
            <div class="admin-icon">
              <iconify-icon icon="iconamoon:discount-fill" class="icon total_lost"></iconify-icon>
            </div>
            <div class="admin-title">
              Lost Leads : {{ total_lost_leads}}</div>
            <!-- <p class="fw-semibold">{{ logged_in_count }}</p> -->
            <!-- <div id="active-user-chart" class="remove-tooltip-title rounded-tooltip-value"></div> -->
          </div>
        </div>
    </div>
    </a>
  </div>




  <div class="card h-100 p-0 radius-12">
    <div
      class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center flex-wrap gap-3 justify-content-between">
      <div class="d-flex align-items-center flex-wrap gap-3">

        <form class="navbar-search">
          <input type="text" class="bg-base h-40-px w-100" name="search" placeholder="Search">
          <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
        </form>
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
          <div class="d-flex align-items-center gap-2">
            <span class="admin-icon">
              <iconify-icon icon="iconamoon:discount-fill" class="icon"></iconify-icon>
            </span>
            <div>
              <span class="mb-2 fw-medium text-secondary-light text-sm">Total Lead : {{ assign_count }}</span>
              <!-- <p class="fw-semibold">{{ logged_in_count }}</p> -->
            </div>
          </div>
          <!-- <div id="active-user-chart" class="remove-tooltip-title rounded-tooltip-value"></div> -->
        </div>
      </div>
    </div>
    <div class="card-body p-24">
      <div class="table-responsive scroll-sm">
        <table class="table bordered-table sm-table mb-0" id="myTable">
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Call</th>
              <th scope="col">Whatsapp</th>
              <!-- <th scope="col">Send</th> -->
              <th scope="col">Status</th>
              <th>Change Status</th>

            </tr>
          </thead>
          <tbody>
            {% for user in assign %}
            <tr>
              <td>{{ user.name }}</td>
              <td>
                <a href="tel:{{ user.call }}">
                  <i class="fas fa-phone" style="font-size:1.1em;"></i></a>
              </td>
              <td>
                <a href="https://wa.me/{{ user.call }}" target="_blank">
                  <i class="fab fa-whatsapp menu-icon" style="font-size:1.5em;"></i>
                </a>
              </td>
              <!-- <td>
              <button class="btn btn-toggle" onclick="toggleSendStatus({{ user.id }}, this)">
                {% if user.send == 'True' %}
                <span class="badge bg-success">Send</span>
                {% else %}
                <span class="badge bg-danger">Don't Send</span>
                {% endif %}
              </button>
            </td> -->

              <td>{{user.status}}</td>
              <td>
                <form action="{% url 'status_update' %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="leads_id" value="{{ user.id }}">
                  <div class="dropdown">

                    <button class="btn btn-primary dropdown-toggle" aria-expanded="false" data-bs-toggle="dropdown"
                      type="button">{{ user.status }}&nbsp;</button>
                    <div class="dropdown-menu">
                      <button class="dropdown-item" type="submit" name="new_status" value="Leads">Leads</button>
                      <button class="dropdown-item" type="submit" name="new_status" value="Intrested">Intrested</button>
                      <button class="dropdown-item" type="submit" name="new_status" value="Not Interested">Not
                        Interested</button>
                      <button class="dropdown-item" type="submit" name="new_status" value="Other Location">Other
                        Location</button>
                      <button class="dropdown-item" type="submit" name="new_status" value="Not Picked">Not
                        Picked</button>
                      <button class="dropdown-item" type="submit" name="new_status" value="Lost">Lost</button>
                      <button class="dropdown-item" type="submit" name="new_status" value="Visit">Visit</button>

                    </div>
                  </div>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>


        </table>
      </div>
    </div>
  </div>
</div>
</div>
<script>
  function searchTable() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("myTable");
    tr = table.getElementsByTagName("tr");

    // Loop through all table rows, and hide those that don't match the search query
    for (i = 0; i < tr.length; i++) {
      var rowShouldBeVisible = false;

      // Loop through all cells of current row
      for (j = 0; j < tr[i].cells.length; j++) {
        td = tr[i].cells[j];
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            rowShouldBeVisible = true;
            break; // If a match is found in this row, no need to check further
          }
        }
      }
      if (rowShouldBeVisible) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
      }
    }

  }
</script>

<script>
  function toggleSendStatus(userId, button) {
    var currentStatus = button.querySelector('.badge').textContent.trim() === 'Send';
    var newSendStatus = !currentStatus;

    fetch('{% url "update_send_status" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token for security
      },
      body: JSON.stringify({
        id: userId,
        send: newSendStatus
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update button text based on the new status
          if (data.new_send_status) {
            button.innerHTML = '<span class="badge bg-success">Send</span>';
          } else {
            button.innerHTML = '<span class="badge bg-danger">Don\'t Send</span>';
          }
        } else {
          alert('Failed to update status: ' + data.message);
        }
      })
      .catch(error => console.error('Error:', error));
  }
</script>

{% endblock %}