{% extends request.user.is_superuser|yesno:'base.html,admin_dashboard/staff/base.html' %}  
{% block content %}
{% load static %}
    
    <div class="dashboard-main-body">

      <div class="dash-title">Interested</div>

    
        <form class="row pb-1 mb-3" method="post" action="{% url 'export_leads_status_wise_staff' %}">
          {% csrf_token %}
        <!-- Start Date -->
        <input type="text" name="all_interested" value="1" hidden>
         <div class="col-lg-3 col-md-4 col-sm-12">
            <!-- <label for="startDate" class="form-label">Start Date</label> -->
            <input type="date" class="form-control form-control-sm" id="startDate" name="start_date" required>

         </div>
         <div class="col-lg-3 col-md-4 col-sm-12">
          <!-- <label for="endDate" class="form-label">End Date</label> -->
          <input type="date" class="form-control form-control-sm" id="endDate" name="end_date" required>
         </div>
     
         <div class="col-lg-2 col-md-4 col-sm-12">
          <button type="submit" class="btn btn-sm w-100">Export</button>
         </div>
        <!-- End Date -->         


      </form>
       


      <div class="card h-100 p-0 radius-12">
         <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center flex-wrap gap-3 justify-content-between">
              <!-- Search Form -->
                  <form class="navbar-search search_bar w-100">
                      <input type="text" id="searchInput" class="bg-base h-40-px form-control" name="search" placeholder="Search" onkeyup="searchTable()">
                      <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
                  </form>

          </div>
          <div class="card-body p-24">
              <div class="table-responsive scroll-sm">
                  <table class="table bordered-table sm-table mb-0" >
                    <thead> 
                      <tr>    
                        <th scope="col">Name</th>
                        <th scope="col">Staff</th>
                        <th scope="col">Team Leader</th>
                        <th class="text-center" scope="col">Call</th>
                        <th class="text-center" scope="col">Whatsapp</th>
                        <!-- <th scope="col">Send</th> -->
                        <!-- <th scope="col">Status</th> -->
                        <!-- <th>Change Status</th> -->
                         {% if request.user.is_team_leader %}  
                        <th class="team_status">Change Status</th>
                        {% endif %}
                        {% if key == 1 %}
                        <th class="text-center">Follow up date</th> 
                        <th class="text-center">Follow up time</th>
                        {% else %}
                        <th class="text-center">Date</th>
                        {% endif %}
                        <th class="text-center">History</th>
                        
                      </tr>
                    </thead>
                    <!-- <tbody id="myTable"> -->
                    <tbody class="myTable" id="tableBody1">
                      {% for user in page %}
                          <tr>
                              <td>{{ user.name }}</td>
                              <td>{{ user.assigned_to.name }}</td>
                              <td>{{ user.team_leader.name }}</td>
                              <td class="text-center">
                                <a href="tel:+91{{ user.call }}">
                                    <i class="fas fa-phone" style="font-size:1.1em; transform: rotate(95deg);"></i></a>
                            </td>            
                            <td class="text-center">
                              <a href="https://wa.me/+91{{ user.call }}" target="_blank">
                                  <i class="fab fa-whatsapp menu-icon" style="font-size:1.5em; color: #25D366;"></i>
                              </a>
                          </td>
                          {% if request.user.is_team_leader %}
                          <td class="team_status text-center">
                            <button
                                type="button"
                                class="btn"
                                data-bs-toggle="modal"
                                data-bs-target="#basicModal1"
                                data-id="{{ user.id }}"
                            >
                                 <!-- <i class="bi bi-pencil-square " style="font-size:1.3em;"></i>  -->
                               Follow Up <i class="bi bi-arrow-down-short"></i>
                            </button>
                          </td>
                          {% endif %}

                          <!-- <td>
                            <button class="btn btn-toggle" onclick="toggleSendStatus({{ user.id }}, this)">
                                {% if user.send == 'True' %}
                                <span class="badge bg-success">Send</span>
                                {% else %}
                                <span class="badge bg-danger">Don't Send</span>
                                {% endif %}
                            </button>
                          </td>  -->
                              
                              <!-- <td>{{user.status}}</td> -->
                              <!-- <td>
                                <form action="{% url 'status_update' %}" method="POST">
                                    {% csrf_token %}
                                <input type="hidden" name="leads_id" value="{{ user.id }}">
                                <div class="dropdown">
                                    
                                    <button class="btn btn-primary dropdown-toggle" aria-expanded="false" data-bs-toggle="dropdown" type="button">{{ user.status }}&nbsp;</button>
                                    <div class="dropdown-menu">
                                      <button class="dropdown-item" type="submit" name="new_status" value="Leads">Leads</button>
                                      <button class="dropdown-item" type="submit" name="new_status" value="Intrested">Intrested</button>
                                      <button class="dropdown-item" type="submit" name="new_status" value="Not Interested">Not Interested</button>
                                      <button class="dropdown-item" type="submit" name="new_status" value="Other Location">Other Location</button>
                                      <button class="dropdown-item" type="submit" name="new_status" value="Not Picked">Not Picked</button>
                                      <button class="dropdown-item" type="submit" name="new_status" value="Lost">Lost</button>
                                      <button class="dropdown-item" type="submit" name="new_status" value="Visit">Visit</button>

                                    </div>
                                </div>
                            </form>
                            </td> -->
                            <!-- <td>
                              <button
                                  type="button"
                                  class="btn btn-primary"
                                  data-bs-toggle="modal"
                                  data-bs-target="#basicModal2"
                                  data-id="{{ user.id }}"
                                >
                                  {{ user.status }} <i class="bi bi-arrow-down-short"></i>
                              </button>
                            </td> -->
                            {% if key == 1 %}
                            <td class="text-center">{{ user.follow_up_date }}</td>
                            <td class="text-center">{{ user.follow_up_time }}</td>
                            {% else %}
                            <td class="text-center"{{ user.updated_date|date:"Y-m-d" }}</td>
                            {% endif %}
                            <td class="text-center">
                              <a href="{% url 'lead_listory' user.id %}"  
                              >
                                  <i class="bi bi-clock-history" style="font-size:1.2em;"></i>
                              </a>
                            </td>
                          </tr>
                      {% endfor %}
                  </tbody>


                  </table>
              </div>
              <nav class="mt-3" aria-label="Page navigation example">
                <ul class="pagination">
                    <!-- First page link -->
                    <li class="page-item {% if not page.has_previous %}disabled{% endif %}">
                        <a class="page-link" href="?page=1" aria-label="First">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
            
                    <!-- Previous page link -->
                    {% if page.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&lsaquo;</span>
                            </a>
                        </li>
                    {% endif %}
            
                    <!-- Page numbers -->
                    {% for num in page_range %}
                        {% if num == '...' %}
                            <li class="page-item disabled"><a class="page-link">...</a></li>
                        {% else %}
                            <li class="page-item {% if num == page.number %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
            
                    <!-- Next page link -->
                    {% if page.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&rsaquo;</span>
                            </a>
                        </li>
                    {% endif %}
            
                    <!-- Last page link -->
                    <li class="page-item {% if not page.has_next %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ page.paginator.num_pages }}" aria-label="Last">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul> 
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>


    <!-- Modal -->
  <div class="modal fade marketingpopup " id="basicModal1" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <form id="leadUpdateForm">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title" id="exampleModalLabel1">Leads Update</h6>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col mb-3">
                <!-- <label for="form-id" class="form-label">Id</label> -->
                <input type="text" id="form-id" class="form-control" readonly hidden/>
              </div>
            </div>
            <div class="row g-2">
              <div class="col-12 mb-3">
                <label for="status" class="form-label">Status</label>
                <select id="status" class="form-select" aria-label="Default select example">
                  <option value="Intrested">Open this select menu</option>
                  <!-- <option value="Leads">Leads</option> -->
                  <!-- <option value="Intrested">Intrested</option> -->
                  <option value="Intrested">Follow Up</option>
                  <!-- <option value="Not Interested">Not Interested</option>
                  <option value="Other Location">Other Location</option>
                  <option value="Not Picked">Not Picked</option> -->
                  <option value="Lost">Discard</option>
                  <option value="Visit">Visit</option>
                </select>
              </div>

            <div class="row g-2" id="follow-up-container"></div>

              <div class="col-12">
                <label for="dobBasic" class="form-label">Message</label>
                <textarea name="message" id="dobBasic" class="form-control"></textarea>
              </div>
            </div> 
          </div>
          <div class="modal-footer">
       
            <button type="button" class="btn btn-outline-secondary" id="saveChangesBtn">Update Status</button>
          </div>
        </div>
      </form>
      
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    document.getElementById('status').addEventListener('change', function () {
      const followUpContainer = document.getElementById('follow-up-container');
      followUpContainer.innerHTML = ''; // Clear previous inputs if any
  
      if (this.value === 'Intrested') {
        // Create Date input
        const dateDiv = document.createElement('div');
        dateDiv.className = 'col-6';
        const dateLabel = document.createElement('label');
        dateLabel.className = 'form-label';
        dateLabel.innerHTML = 'Follow Up Date';
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.className = 'form-control';
        dateInput.id = 'follow-up-date';
        dateDiv.appendChild(dateLabel);
        dateDiv.appendChild(dateInput);
        
        // Create Time input
        const timeDiv = document.createElement('div');
        timeDiv.className = 'col-6';
        const timeLabel = document.createElement('label');
        timeLabel.className = 'form-label';
        timeLabel.innerHTML = 'Follow Up Time';
        const timeInput = document.createElement('input');
        timeInput.type = 'time';
        timeInput.className = 'form-control';
        timeInput.id = 'follow-up-time';
        timeDiv.appendChild(timeLabel);
        timeDiv.appendChild(timeInput);
  
        // Append both to the container
        followUpContainer.appendChild(dateDiv);
        followUpContainer.appendChild(timeDiv);
      }
    });
  </script>

<script>

document.addEventListener('DOMContentLoaded', function () {
    $('#basicModal1').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);  
        var id = button.data('id');           
        
        $.ajax({
            url: '/lead_user/' + id,  
            method: 'GET',
            success: function (data) {
                $('#form-id').val(data.id);
                $('#dobBasic').val(data.message);  
                $('select.form-select').val(data.status); 
                $('#follow-up-date').val(data.follow_up_date);
                $('#follow-up-time').val(data.follow_up_time);  

                const followUpContainer = $('#follow-up-container');
                followUpContainer.empty();  // Clear previous inputs if any

                // Check if follow_up_date is available in the data
                if (data.follow_up_date && data.follow_up_time) {
                  
                    // Display Follow Up Date and Time inputs
                    const followUpDateInput = `
                        <div class="col-6">
                          <label for="follow-up-date" class="form-label">Follow Up Date</label>
                          <input type="date" class="form-control" id="follow-up-date" value="${data.follow_up_date}">
                        </div>
                        <div class="col-6">
                          <label for="follow-up-time" class="form-label">Follow Up Time</label>
                          <input type="time" class="form-control" id="follow-up-time" value="${data.follow_up_time}">
                        </div>
                    `;
                    followUpContainer.append(followUpDateInput);
                } else {
                    // Show empty follow-up container (for cases where follow-up date/time is not available)
                    followUpContainer.append('<div class="col-12">No Follow Up Details Available</div>');
                }
            },
            error: function () {
                alert('Failed to retrieve data.');
            }
        });
    });
});


$(document).ready(function() {
    $('#saveChangesBtn').on('click', function (e) {
        e.preventDefault();  
        
        console.log("Button clicked");

        var id = $('#form-id').val();
        var status = $('#status').val();  
        var message = $('#dobBasic').val();
        var followDate = $('#follow-up-date').val();  
        var followTime = $('#follow-up-time').val();        

        $.ajax({
            url: '/lead_user/update/' + id + '/',
            method: 'POST',
            data: {
                'status': status,
                'message': message,
                'followDate': followDate,
                'followTime': followTime,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function (response) {
                alert('Changes saved successfully.');
                location.reload();  
            },
            error: function () {
                alert('Failed to save changes.');
            }
        });
    });
});

    // function searchTable() {
    //   var input, filter, table, tr, td, i, txtValue;
    //   input = document.getElementById("searchInput");
    //   filter = input.value.toUpperCase();
    //   table = document.getElementById("myTable");
    //   tr = table.getElementsByTagName("tr");
  
    //   // Loop through all table rows, and hide those that don't match the search query
    //   for (i = 0; i < tr.length; i++) {
    //     var rowShouldBeVisible = false;
  
    //     // Loop through all cells of current row
    //     for (j = 0; j < tr[i].cells.length; j++) {
    //       td = tr[i].cells[j];
    //       if (td) {
    //         txtValue = td.textContent || td.innerText;
    //         if (txtValue.toUpperCase().indexOf(filter) > -1) {
    //           rowShouldBeVisible = true;
    //           break; // If a match is found in this row, no need to check further
    //         }
    //       }
    //     }
    //     if (rowShouldBeVisible) {
    //       tr[i].style.display = "";
    //     } else {
    //       tr[i].style.display = "none";
    //     }
    //   }
  
    // }

//     function searchTable() {
//     const searchInput = document.getElementById("searchInput").value;
//     const url = "{% url 'teamcustomer' tag='Intrested' %}";  // Adjust with your URL pattern
    
//     $.ajax({
//         url: url,
//         data: {
//             'search': searchInput,
//         },
//         success: function(data) {
//             const parsedData = JSON.parse(data);
//             const tableBody = document.getElementById("myTable");
//             tableBody.innerHTML = '';

//             parsedData.forEach(user => {
//                 const userFields = user.fields;
//                 const row = `
//                     <tr>
//                         <td>${userFields.name}</td>
//                         <td>${userFields.assigned_to ? userFields.assigned_to.name : ''}</td>
//                         <td>${userFields.team_leader ? userFields.team_leader.name : ''}</td>
//                         <td><a href="tel:+91${userFields.call}"><i class="fas fa-phone" style="font-size:1.1em;"></i></a></td>
//                         <td><a href="https://wa.me/+91${userFields.call}" target="_blank"><i class="fab fa-whatsapp menu-icon" style="font-size:1.5em;"></i></a></td>
//                         ${request.user.is_team_leader ? `<td class="team_status"><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#basicModal1" data-id="${user.pk}">Follow Up <i class="bi bi-arrow-down-short"></i></button></td>` : ''}
//                         ${key == 1 ? `<td>${userFields.follow_up_date}</td><td>${userFields.follow_up_time}</td>` : `<td>${userFields.updated_date}</td>`}
//                     </tr>`;
//                 tableBody.innerHTML += row;
//             });
//         }
//     });
// }

$(document).ready(function(){
        $("#searchInput").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            
            $.ajax({
                url: "{% url 'teamcustomer' tag='Intrested' %}",
                type: 'GET',
                data: { 'search': value },
                success: function(data) {
                    var tbodyContent = $(data).find('tbody.myTable').html()
                    $("#tableBody1").html(tbodyContent);
                }
            });
        });
    });

  </script>

  <script>
    function toggleSendStatus(userId, button) {
        var currentStatus = button.querySelector('.badge').textContent.trim() === 'Send';
        var newSendStatus = !currentStatus;

        fetch('{% url "update_send_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token for security
            },
            body: JSON.stringify({
                id: userId,
                send: newSendStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button text based on the new status
                if (data.new_send_status) {
                    button.innerHTML = '<span class="badge bg-success">Send</span>';
                } else {
                    button.innerHTML = '<span class="badge bg-danger">Don\'t Send</span>';
                }
            } else {
                alert('Failed to update status: ' + data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    }
  </script>

{% endblock %}